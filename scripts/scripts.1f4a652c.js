"use strict";angular.module("projectVApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap","facebook","firebase","angulartics","angulartics.google.analytics"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/plan",{templateUrl:"views/plan.html"}).when("/demo",{templateUrl:"views/demo.html"}).when("/petition",{templateUrl:"views/petition.html",controller:"PetitionCtrl"}).when("/mission/:county",{templateUrl:"views/mission.html",controller:"MissionCtrl"}).when("/mroute/:county",{templateUrl:"views/blank.html",controller:"MrouteCtrl"}).when("/map/:county",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/minimap/:county",{templateUrl:"views/minimap.html",controller:"MapCtrl"}).when("/aftermap/:county",{templateUrl:"views/aftermap.html",controller:"AftermapCtrl"}).when("/faq",{templateUrl:"views/faq.html",controller:"FaqCtrl"}).when("/mobile",{templateUrl:"views/mobile.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]).config(["FacebookProvider",function(a){var b="244089402325240";a.init(b)}]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]).filter("newlines",function(){return function(a){return a.split(/\n/g)}}),angular.module("projectVApp").controller("MainCtrl",["$scope","Countdown","FINALDATE","$interval","$anchorScroll",function(a,b,c,d,e){e(),a.time=b.getTime(new Date(c),new Date),d(function(){a.time=b.getTime(new Date(c),new Date)},1e3)}]),angular.module("projectVApp").controller("PetitionCtrl",["$scope",function(){}]),angular.module("projectVApp").controller("MissionsCtrl",["$scope","$modal",function(a,b){a.missions=[{id:"TPE-4",name:"TPE-4",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-1",name:"TPQ-1",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-6",name:"TPQ-6",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"}],a.registerDialog=function(a){b.open({templateUrl:"views/closereg.html",controller:"registerCloseController",size:"md",resolve:{data:function(){return{county:"Taiwan",type:a}}}})}}]),angular.module("projectVApp").controller("PagesCtrl",["$scope","$location",function(a,b){-1==b.url().indexOf("minimap")&&(a.showNav=!0,a.pages=[{id:"news",name:"戰略消息",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-03.svg","class":"nav-title",cssid:"nav2"},{id:"plan",name:"罷免日計劃",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-05.svg","class":"nav-title",cssid:"nav3"},{id:"demo",name:"自由罷免示範區",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-07.svg","class":"nav-title",cssid:"nav4"},{id:"petition",name:"連署書資訊",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-09.svg","class":"nav-title",cssid:"nav5"},{id:"faq",name:"FAQ"},{name:"T-shrt 贊助",href:"http://tshirt.appy.tw/",target:"_blank"}],a.getActive=function(a){return b.url().substr(1)===a?"active":""},a.getHref=function(a){return a.href?a.href:"#/"+a.id},a.getTarget=function(a){return a.target?a.target:"_self"})}]);var DEFAULT_COUNTY="TPE-4",MAP_RELOAD_TIME=1e4,MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("MapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","$location","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){m(D)}function m(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(D.length-b.length)/D.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:n,resetStyleOnMouseout:!1},setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=z&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=z&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=z&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function n(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function o(a){var b=a.feature.properties.mycolor;return{fillColor:b}}function p(){return{weight:2,color:"black",dashArray:"6"}}function q(){return{weight:6,color:"yellow",dashArray:"0"}}function r(a,b){var c=b.target;c!=A&&(c.setStyle(I),c.bringToFront(),A&&A.bringToFront())}function s(a,b){var c=b.target;c!=A&&(c.setStyle(J),c.bringToFront(),A&&A.bringToFront())}function t(b,c,d){a.$emit("dataReload");var e=d.target.feature.properties.town,f=d.target.feature.properties.village,g=d.target;u(e,f,g),v(e,f,0)}function u(a,b,c){A&&A.setStyle(p()),c.setStyle(q()),c.bringToFront(),A=c}function v(b,c,d){a.myscope.showVS={},a.myscope.showVS.townName=b,a.myscope.showVS.villageName=c,a.myscope.showVS.vsArray=[],a.markers={};var e=[],f=0;angular.forEach(a.myscope.voteStatData[b],function(g){var h=g.neighborhood.indexOf(c);-1!=h&&(a.myscope.showVS.vsArray.push({name:g.name,id:g.id}),e.length==d&&(f=g.id),e.push({vsid:g.id,townName:b,villageName:c,vspos:e.length,vscount:H(.5*(a.myscope.vsInfo[g.id].volunteer+a.myscope.vsInfo[g.id].supplement)),vsobj:{lat:g.location.lat,lng:g.location.lng}}))}),e.length>0&&(x(e),a.myscope.setCurrentMarkerClick(f,!1,!1)),a.leafletData.getMap().then(function(a){var b=[];if(A){var c=A.getBounds();b.push({lat:c._northEast.lat,lng:c._northEast.lng}),b.push({lat:c._southWest.lat,lng:c._southWest.lng})}for(var d=0;d<e.length;d++)b.push({lat:e[d].vsobj.lat,lng:e[d].vsobj.lng});b.length>0&&a.fitBounds(b)})}function w(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function x(b){var c={};B=null,angular.forEach(b,function(a){var b=a.vscount;c[a.vsid]={draggable:!1,lat:a.vsobj.lat,lng:a.vsobj.lng,icon:F[b].x,myicons:F[b],mycount:b,mypos:a.vspos,myloc:a.townName+"-"+a.villageName,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName,!1,!0)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=B?d.myicons.x:d.myicons.c})}function y(b){k.resetDynamics(z),b&&k.getStaticVillageData(z).then(function(a){(a.county=z)&&l()},function(){},function(b){(b.county=z)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=G(b.villageSum),D.push(b.villageArea)))}),e.all([k.getAllVoteStatInfo(z),k.getAllVoteStatData(z),k.getAllVillageSum(z)]).then(function(c){a.myscope.vsInfo=c[0],a.myscope.voteStatData=c[1],a.myscope.villageSum=c[2],b?(a.myscope.villList=Object.keys(a.myscope.villageSum),a.myscope.currentTownTab=a.myscope.villList[0]):(a.myscope.showVS&&v(a.myscope.showVS.townName,a.myscope.showVS.villageName,C),a.leafletData.getGeoJSON().then(function(b){var c=b.getLayers();angular.forEach(c,function(b){var c=b.feature.properties.town,d=b.feature.properties.village;b.feature.properties.mycolor=G(a.myscope.villageSum[c][d]),b.setStyle(o(b)),A&&A.setStyle(q())})}))})}a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var z=c.county,A=null,B=null,C=0,D=[],E=(new Date).getTime();a.myscope.county=z,a.myscope.voteStatData=null,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.myscope.supplementItem=k.supplementItem,a.myscope.volCount=k.volCount,a.myscope.villList=[],a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1,a.myscope.spPeopleClick=function(){a.myscope.spPeopleMore=!a.myscope.spPeopleMore},a.myscope.hpPeopleClick=function(){a.myscope.hpPeopleMore=!a.myscope.hpPeopleMore},a.leafletData=j;var F=function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();z in MAP_DEFAULT_BOUND||(z=DEFAULT_COUNTY);var G=function(a){return null==a?"#333333":a>=1?"#990000":a>.5?"#993333":a>0?"#aa6666":"#aaaaaa"},H=function(a){return a>.66?3:a>.33?2:1};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?0==a.myscope.showVS.vsArray.length?3:a.myscope.showVS?H(.5*(a.myscope.vsInfo[a.myscope.currentVsTab.vsId].volunteer+a.myscope.vsInfo[a.myscope.currentVsTab.vsId].supplement)):1:1};var I={weight:6,color:"white"},J={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.$emit("dataReload"),a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&u(b,c,a)})}),v(b,c,0)},a.myscope.setCurrentMarkerClick=function(b,c){a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1;var d=a.markers[b];C=d.mypos,w(b),B&&(B.icon=B.myicons.x),d.icon=d.myicons.c,B=d,c&&a.leafletData.getMap().then(function(a){a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.$emit("dataReload"),a.myscope.showVS=null,B=null,C=0,a.markers={},A&&(A.setStyle(p()),A=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])})},a.$on("leafletDirectiveMap.geojsonMouseover",r),a.$on("leafletDirectiveMap.geojsonMouseout",s),a.$on("leafletDirectiveMap.geojsonClick",t),a.myscope.registerDialog=function(a){g.open({templateUrl:"views/closereg.html",controller:"registerCloseController",size:"md",resolve:{data:function(){return{county:z,type:a}}}})},a.myscope.reportDialog=function(){var b=g.open({templateUrl:"views/report.html",controller:"ReportCtrl",size:"md",resolve:{data:function(){return{county:z,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName}}}});b.result.then(function(){})},a.defaults={zoomControlPosition:"bottomright",scrollWheelZoom:!1,minZoom:MAP_MIN_ZOOM[z]},a.maxbounds={northEast:MAP_DEFAULT_BOUND[z][0],southWest:MAP_DEFAULT_BOUND[z][1]},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])}),y(!0),a.$on("dataReload",function(){var b=(new Date).getTime();b-E>MAP_RELOAD_TIME&&(E=b,a.$emit("missionDataReload"),y(!1))}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]);var MY_HTTP_DELAY=200,MY_HTTP_RETRY=3e3,MY_REQUERY_TIME=1e4;angular.module("projectVApp").service("voteInfoService",["$q","$http",function(a,b){function c(c,d){function e(a){s[c]=0,f.resolve(r[c][a])}var f=a.defer();if(s[c]+=1,s[c]>1)var g=setInterval(function(){r[c][d]&&(clearInterval(g),e(d))},MY_HTTP_DELAY);else if(r[c][d])e(d);else{var h=function(){var a="json/"+c+"/"+d+".json";b.get(a).success(function(a){r[c][d]=a,e(d)}).error(function(){setTimeout(function(){h()},MY_HTTP_RETRY)})};h()}return f.promise}this.MAP_BUFFER_TIME=10,Parse.initialize("QDCw1Ntq4E9PmPpcuwKbO2H0B1H0y77Vj1ScO9Zx","6jaJvf46pYub6Ej9IjhhIXNtZjTqRY0P4IqAJFhH");var d=Parse.Object.extend("citizen"),e=Parse.Object.extend("poll"),f=(Parse.Object.extend("volunteer"),Parse.Object.extend("resource"),Parse.Object.extend("report")),g=Parse.Object.extend("bossHp"),h=Parse.Object.extend("afterStation"),i={},j={},k={},l={},m=this;this.supplementItem={pen:[5,"筆"],board:[5,"連署板"],water:[5,"水"],chair:[2,"椅子"],desk:[1,"桌子"],umbrella:[1,"水果攤用大傘"]},this.volCount=5;var n=0,o=0,p=0,q={},r={votestat:{},villageVotestat:{},twCountyVillage:{}},s={votestat:0,villageVotestat:0,twCountyVillage:0};this.getAllVoteStatData=function(a){return c("votestat",a)},this.getAllVillageVotestatData=function(a){return c("villageVotestat",a)},this.getCountyVillage=function(a){return c("twCountyVillage",a)},this.getParsedQuery=function(b,c,d,e,f){function g(a){q[a].count=0,h.resolve(q[a].results)}var h=a.defer(),i=c+"_"+b+"_"+d+"_"+e+"_"+f;q[i]||(q[i]={count:0}),q[i].count+=1;var j=(new Date).getTime();if(f||(f=1e3),q[i].time&&j-q[i].time<MY_REQUERY_TIME)g(i);else if(q[i].count>1)var k=setInterval(function(){q[i].results&&(clearInterval(k),g(i))},MY_HTTP_DELAY);else{var l=function(){b.descending("createdAt"),b.equalTo(d,e),b.limit(f),b.find({success:function(a){q[i]={time:j,results:a,count:0},h.resolve(a)},error:function(){setTimeout(function(){l()},MY_HTTP_RETRY)}})};l()}return h.promise},this.getCitizenData=function(b){function c(a){o=0,f.resolve(i[a])}function d(a){var b=a.get("resourceBody")?angular.copy(a.get("resourceBody")).reverse():[],c=a.get("volunteerBody")?angular.copy(a.get("volunteerBody")).reverse():[];return{county:a.get("county"),poll:a.get("poll"),resource:a.get("resource"),volunteer:a.get("volunteer"),resourceBody:b,volunteerBody:c}}var f=a.defer();if(o+=1,i[b])c(b);else if(o>1)var g=setInterval(function(){i[b]&&(clearInterval(g),c(b))},MY_HTTP_DELAY);else{var h=new Parse.Query(e);m.getParsedQuery(h,"pollParse","county",b).then(function(a){for(var e=[],f=0;f<a.length;f++)e.push(d(a[f]));i[b]=e,c(b)})}return f.promise},this.getAllVillageSum=function(b){function c(a){n=0,d.resolve(j[a])}var d=a.defer();if(n+=1,j[b])c(b);else if(n>1)var e=setInterval(function(){j[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else a.all([m.getAllVoteStatData(b),m.getCitizenData(b),m.getAllVillageVotestatData(b)]).then(function(a){var d=a[0],e=a[1],f=a[2],g={},h={};for(var i in d)for(var k=0;k<d[i].length;k++)h[d[i][k].id]=d[i][k].power;for(var k=0;k<e.length;k++){var l=e[k],n=l.poll;g[n]=0;var o=l.volunteer>h[n]*m.volCount?1:l.volunteer/(h[n]*m.volCount),p=0,q=0;for(var r in m.supplementItem){var s=l.resource[r]?l.resource[r]:0;p+=s>h[n]*m.supplementItem[r][0]?1:s/(h[n]*m.supplementItem[r][0]),q+=1}g[n]=(o+p/q)/2}var t={};for(var u in f){t[u]={};for(var v in f[u]){for(var w=f[u][v],x=0,k=0;k<w.length;k++)g[w[k]]&&(x+=g[w[k]]);t[u][v]=0==w.length?null:x/w.length}}j[b]=t,c(b)});return d.promise},this.getAllVoteStatInfo=function(b){function c(a){p=0,d.resolve(k[a])}var d=a.defer();if(p+=1,k[b])c(b);else if(p>1)var e=setInterval(function(){k[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else a.all([m.getCitizenData(b),m.getAllVoteStatData(b)]).then(function(a){var d=a[0],e=a[1],f={};for(var g in e)for(var h=0;h<e[g].length;h++){var i=e[g][h];f[i.id]={vlist:[],vCount:0,volunteer:0,slist:[],sItemCount:{},sItemSum:0,sTotalSum:0,supplement:0,address:i.address,vweight:i.power}}for(var h=0;h<d.length;h++){var j=d[h],l=j.poll,n=j.resource;f[l].vCount=j.volunteer,f[l].vlist=j.volunteerBody,f[l].slist=j.resourceBody;for(var o in m.supplementItem)f[l].sItemCount[o]||(f[l].sItemCount[o]=0),n[o]&&parseInt(n[o])>0&&(f[l].sItemCount[o]=parseInt(n[o]))}for(var p in f){var q=f[p].vweight*m.volCount;f[p].volunteer=f[p].vCount>q?1:f[p].vCount/q;var r=0,s=0;for(var o in m.supplementItem){var t=m.supplementItem[o][0]*f[p].vweight;r+=t,f[p].sItemCount[o]||(f[p].sItemCount[o]=0),s+=f[p].sItemCount[o]>=t?t:f[p].sItemCount[o]}f[p].sItemSum=s,f[p].sTotalSum=r,f[p].supplement=s>r?1:s/r}k[b]=f,c(b)});return d.promise},this.getStaticVillageData=function(c){var d=a.defer(),e=0,f=0,g=0;return a.all([m.getCountyVillage(c),m.getAllVillageSum(c)]).then(function(a){function h(a,b,h){f+=1,setTimeout(function(){g+=1;var f=0;j[b]&&(null==j[b][h]||j[b][h])&&(f=j[b][h]),d.notify({villageArea:k[a],villageSum:f,loadingStatus:g/e,county:c}),g==e&&d.resolve({complete:!0,loadingStatus:g/e,county:c})},m.MAP_BUFFER_TIME*f)}var i=a[0],j=a[1];l[c]=l[c]?l[c]:{};var k=l[c];angular.forEach(i,function(a,d){angular.forEach(a,function(a){e+=1;var f=c+"_"+d+"_"+a;if(k[f])h(f,d,a);else{var g="json/twVillage2010/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){k[f]=b,h(f,d,a)}).error(function(){k[f]={},h(f,d,a)})}})})}),d.promise},this.saveCitizen=function(a,b){var c=new d;c.save(a).then(function(){b()})},this.saveReport=function(a,b){var c=new f;c.save(a).then(function(){b()})},this.queryCitizen=function(){var b=a.defer();return b.resolve(!1),b.promise},this.getBossHp=function(b){var c=a.defer(),d=new Parse.Query(g);return m.getParsedQuery(d,"hpQuery","county",b,1).then(function(a){var b=a[0];c.resolve({total:b.get("total"),receive:b.get("receive")})}),c.promise},this.getStatData=function(b){var c=a.defer(),d=new Parse.Query(h);return m.getParsedQuery(d,"afterStatQuery","county",b).then(function(a){for(var b=[],d=0;d<a.length;d++){var e=a[d];b.push({name:e.get("name"),latlng:e.get("latlng")})}console.log("statData",b),c.resolve(b)}),c.promise},this.resetDynamics=function(a){i[a]&&delete i[a],j[a]&&delete j[a],k[a]&&delete k[a]}}]);var BOSS_DESCRIPTION={"TPE-4":{name:"祭止兀",img:"images/head-tsai.png"},"TPQ-6":{name:"林鴻池",img:"images/head-lin.png"},"TPQ-1":{name:"WEGO昇",img:"images/head-wu.png"}};angular.module("projectVApp").controller("MissionCtrl",["$scope","$route","$routeParams","voteInfoService","FeedService","$anchorScroll",function(a,b,c,d,e,f){function g(){d.getAllVoteStatInfo(h).then(function(b){var c=0,e=0,f=0,g=0;for(var h in b){var i=d.volCount*b[h].vweight;e+=i,c+=b[h].vCount>=i?i:b[h].vCount;for(var j in d.supplementItem){var k=d.supplementItem[j][0]*b[h].vweight;g+=k,f+=b[h].sItemCount[j]>=k?k:b[h].sItemCount[j]}}a.miscope.vCount=c,a.miscope.vTotal=e,a.miscope.sCount=f,a.miscope.sTotal=g})}f();var h=c.county,i="effect:",j="area:",k="type:",l=/「(.+)」.*by(.*)。/i;a.miscope={},a.miscope.county=h,a.miscope.vCount=0,a.miscope.vTotal=0,a.miscope.sCount=0,a.miscope.sTotal=0,a.miscope.boss=BOSS_DESCRIPTION[h],a.miscope.newCitizen=[],a.miscope.mapLoadingComplete=!1,d.getBossHp(h).then(function(b){a.miscope.bossHP=b}),e.parseFeed("http://appyv.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=c[Math.floor(Math.random()*c.length)],e=d.content.match(l),f=new DOMParser,g=f.parseFromString(d.content,"text/html");if(e){a.speech=e[1],a.citizen=e[2];var h=g.querySelector("img");h&&(a.citizenAvatar={"background-image":"url("+h.src+")"})}}),e.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=[],e=[],f=[],g=6;angular.forEach(c,function(a){angular.forEach(a.categories,function(b){0===b.indexOf(j)?a.area=b.substr(j.length):0===b.indexOf(i)?a.effect=b.substr(i.length).replace("-"," "):0===b.indexOf(k)&&(a.type=b.substr(k.length))}),a.area||(a.area="all"),("all"===a.area||a.area===h)&&d.push(a)}),angular.forEach(d,function(a){"boss"===a.type?e.length<g&&e.push(a):a.type&&"v"!==a.type&&f.length<g&&f.push(a)}),a.bossFeeds=angular.copy(e),a.citizenFeeds=angular.copy(f)}),g(),a.$on("missionDataReload",function(){g()}),a.miscope.gotoMap=function(){$("html, body").animate({scrollTop:$("#mission_map_container").offset().top},500)},d.getBossHp(h)}]),angular.module("projectVApp").controller("registerDialogController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data","$analytics",function(a,b,c,d,e,f,g){function h(b){a.$apply("connected"==b.status?function(){a.me()}:function(){a.logged=!1,n=!1,a.fbname="",a.editState=0,a.unregster=0})}function i(b){if(b&&b.id){a.content.userid=b.id,a.content.name=b.name,a.fbname=b.name,a.content.phone="",a.content.email="",a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content.areaOrder=[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],a.content.supplement={};for(var c in o)a.content.supplement[c]=0;e.queryCitizen(b.id,f.type).then(function(b){a.unregster=b?1:2})}else a.me()}function j(a){return/^\+?(0|[1-9]\d*)$/.test(a)}function k(){var b={fid:parseInt(a.content.userid),volunteer:"volunteer"==a.content.type,poll:f.vsId,name:a.content.name,mobile:a.content.phone,email:a.content.email,county:f.county,resource:a.content.supplement};a.regscope.nonArea&&(b.areaOrder=a.content.areaOrder.join(",")),e.saveCitizen(b,function(){g.eventTrack("join",{areaOrder:b.areaOrder,volunteer:b.volunteer,county:b.county,resource:b.resource}),a.editState=3})}function l(){var b=a.regscope.fbmessage;d.api("/me/feed","post",{message:b,link:"http://1129vday.tw/"},function(a){!a||a.error||g.eventTrack("postToFacebook")})}a.regscope={};var m="我已經報名「割闌尾V計劃」志工了！\n11/29 割闌尾計畫於三個選區的投票所外不妨害投票行為的地點，設立「罷免連署示範攤位」，並邀請所有公民V有物資出物資、有力出力，擔任一天志工或贊助當日擺攤一日物資所需。\n#1129一日志工 ＃我們一起讓罷免復活 ＃割闌尾V計劃";a.logged=!1,a.fbname="",a.unregster=0,a.editState=0,a.facebookReady=!1,a.$watch(function(){return d.isReady()},function(b){b&&(a.facebookReady=!0)});var n=!1;a.intentLogin=function(){a.login()},a.login=function(){d.login(function(a){h(a)},{scope:"publish_stream,publish_actions"})},a.me=function(){d.api("/me",function(b){a.$apply(function(){b.error||(i(b),a.logged=!0,n=!0)})})},a.logout=function(){d.logout(function(){a.$apply(function(){a.logged=!1,n=!1,a.fbname="",a.unregster=0,a.editState=0,a.regscope.errors=""})})},a.$on("Facebook:statusChange",function(a,b){h(b)}),d.getLoginStatus(function(a){h(a)}),a.regscope.selectItems=e.supplementItem;var o=a.regscope.selectItems;a.regscope.nonAreaSelect=["台北市","新北市","台南市","高雄市"],a.regscope.type=f.type,a.regscope.nonArea=f.nonArea,a.regscope.supCount=f.supCount,a.regscope.supWeight=f.supWeight,a.regscope.errors="",a.regscope.newuser=!0,a.regscope.fbshare=!0,a.regscope.fbmessage=m,a.content={type:f.type,votestat:f.vsName,vsid:f.vsId,userid:"",name:"",phone:"",email:"",areaOrder:[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],supplement:{}};for(var p in o)a.content.supplement[p]=0;var q={name:"暱稱",phone:"手機",email:"E-Mail"},r=function(){var b=a.content.supplement;for(var c in o)if(!j(b[c]))return[!1,"物資數量填寫錯誤"];for(var c in o)if(b[c]>0)return[!0,""];return[!1,"請填選您要提供的物資"]};a.send=function(){var b=[];if(a.content.register.$invalid){var d=a.content.register;for(var e in q)d[e].$error.required&&b.push("請填寫您的"+q[e]),d[e].$error.email&&b.push("您的"+q[e]+"格式不符")}var f=r();"supplement"!=a.content.type||f[0]||b.push(f[1]),0==b.length?0==a.editState?a.editState=1:1==a.editState?(a.editState=2,1==a.regscope.fbshare&&l(),k()):3==a.editState&&c.close(!0):a.regscope.errors=b.join("，")},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").controller("registerCloseController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data","$analytics",function(a,b,c,d,e,f){a.regscope={},a.regscope.type=f.type,a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").factory("FeedService",["$http",function(a){return{parseFeed:function(b){return a.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(b+"?"+(new Date).getTime()))}}}]),angular.module("projectVApp").controller("NewsCtrl",["$scope","FeedService","Countdown","FINALDATE","$interval",function(a,b,c,d,e){var f={street:"掃街活動",speech:"宣講活動",music:"音樂活動",multiple:"綜合活動",hide:"隱藏活動",boss:"魔王消息"};b.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=[];angular.forEach(b.data.responseData.feed.entries,function(a){c.length>=10||(c.push(a),angular.forEach(a.categories,function(b){if(0===b.indexOf("type:")){var c=b.substr("type:".length);a.type=c,a.tag=f[c]}}),a.tag||(a.tag="最新消息",a.type="multiple"))}),a.feeds=c}),a.time=c.getTime(new Date(d),new Date),e(function(){a.time=c.getTime(new Date(d),new Date)},1e3)}]),angular.module("projectVApp").service("Countdown",function(){return{getTime:function(a,b){var c=a-b,d=parseInt(c/1e3/60/60),e=parseInt(d/24);d-=24*e;var f=parseInt(c/6e4-60*d),g=parseInt(c/1e3%60),h=parseInt(5*g/3);return{days:e,hours:d,minutes:f,seconds:g,ratio:h}}}}),angular.module("projectVApp").constant("FINALDATE","2014/11/29"),angular.module("projectVApp").controller("MrouteCtrl",["$scope","$routeParams","$location",function(a,b,c){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var d=b.county;c.path("/mission/"+d)}]),angular.module("projectVApp").controller("ReportCtrl",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data",function(a,b,c,d,e,f){a.errortype=["投開票所在地圖上標錯位置","投開票所名稱有誤","投開票所地址有誤","投開票所的所屬里有誤","此投開票所不存在","其他"],a.hassave=!1,a.report={county:f.county,poll:f.vsId,type:a.errortype[0],content:""},a.save=function(){a.hassave=!0,e.saveReport(a.report,function(){setTimeout(function(){c.close(!0)},1e3)})},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").controller("FaqCtrl",["$scope","$analytics",function(a,b){b.eventTrack("faq"),a.items=[{q:"因為不知道志工要作什麼，所以不太敢答應",a:"我們 V 計畫一日志工，主要是希望您可以在投完票後，能夠去您所在的投開票所，或是你所想要佔領的投開票所，同我們一起當「割友」現場收取連署書！"},{q:"網站要求張貼到 facebook 的權限，但沒有說明會貼什麼，請問會張貼哪些資訊到 Facebook？",a:"我們在臉書上僅會貼出「你已報名當志工！」等宣傳網站資訊，希望可以分享給您臉書社群的好朋友一起共襄盛舉！而割闌尾團隊有法律團隊把關著，個資資料僅會作於聯繫您使用，絕對不會將個資外洩！！"},{q:"我提供的資料有需要修改的地方，要在哪邊修改呢？",a:'若您有任何需要修改的地方，請寄信到 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a>'},{q:"物資表裡面有個項目我不懂，什麼是水果攤用大傘（俗稱五百萬傘）阿？",a:'讓我們一起看笨版長知識 XDDDD <a target="_blank" href="https://www.ptt.cc/bbs/StupidClown/M.1401775870.A.305.html">[無言] 500萬的傘</a>'},{q:"資料填錯了要怎麼辦呀？ 後悔想要換投開所怎麼辦？",a:'如果有資料想要更改或是想要更換投開票所，請洽詢 <a href="mailto:appy.volunteer@gmail.com">appy.volunteer@gmail.com</a> 會有專人跟你聯絡唷！'},{q:"為什麼有些投開所的比例怪怪的啊？有些五個人有些甚至到65個人？",a:"通常會有很多人的需求的投開票所，通常因為在同一個地址內（例如：學校）有很多個投開票所（例如：很多教室）。因此為了因應兩倍甚至到五倍的選舉人會前往投票，攤位人員的需求也會隨之提升囉！"},{q:"為什麼有些里顯示為沒有投開票所，但是點選旁邊的里時，又會有投開票所在該裡出現呢？",a:'我們投開票所資料是根據中選會官方的資料所標示。其中有些會是A里的投開票所在B里，或是有些里沒有設置投開票所。如有問題也麻煩請回報 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a> 會有專人跟你聯絡唷！'},{q:"為什麼我的瀏覽器顯示會有問題怪怪的呀？",a:"身為專業的工程師在此呼籲，請多用 Chrome及 Firefox！ (地方的工程師只有一個肝.... 沒有空再做其他流覽器相容啦XDDDD) "},{q:"報名後怎麼毫無反應只是報名完成？為什麼我報名完後沒有收到信，隔天再報名的時候才收到阿 (而且還是在垃圾郵件信夾？) ",a:"關於出現毫無反應的結果請檢查一下您的垃圾郵件夾，誰知道現在的黨工.... 另外如果報名第二次才成功，可能是系統忙碌中，沒有收到你的請求喔！請多見諒了！"},{q:"我要怎麼看到自己報名的投開票所阿？",a:"我們認為現在網站的體驗，要再弄這個功能比較沒有感受到使用者體驗 (其實是懶得做XDDD) 不過....嘿嘿.... There's one more thing coming!!! 敬請期待!!"},{q:"我的問題沒有列在 FAQ 裡面",a:'請寄信至 <a href="mailto:appy.service@gmail.com">appy.service@gmail.com</a>，我們將會盡快回覆您'},{q:"我發現網站有 bug!",a:'請到 <a target="_blank" href="https://github.com/g0v/projectV/issues">github</a> 回報網站錯誤'}]}]),angular.module("projectVApp").filter("htmlToPlaintext",function(){return function(a){return a=a||"",String(a).replace(/<[^>]+>/gm,"").replace(/&[\d\w]+;/,"").replace("more","").replace("!--","")}});var DEFAULT_COUNTY="TPE-4",MAP_RELOAD_TIME=1e4,MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("AftermapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","$location","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){m(A)}function m(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(A.length-b.length)/A.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:n,resetStyleOnMouseout:!1},setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=w&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=w&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=w&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function n(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function o(){return{weight:2,color:"black",dashArray:"6"}}function p(){return{weight:6,color:"yellow",dashArray:"0"}}function q(a,b){var c=b.target;c!=x&&(c.setStyle(E),c.bringToFront(),x&&x.bringToFront())}function r(a,b){var c=b.target;c!=x&&(c.setStyle(F),c.bringToFront(),x&&x.bringToFront())}function s(b,c,d){a.$emit("dataReload");var e=d.target.feature.properties.town,f=d.target.feature.properties.village,g=d.target;t(e,f,g)}function t(a,b,c){x&&x.setStyle(o()),c.setStyle(p()),c.bringToFront(),x=c}function u(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function v(){k.resetDynamics(w),k.getStaticVillageData(w).then(function(a){(a.county=w)&&l()},function(){},function(b){(b.county=w)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=C(b.villageSum),A.push(b.villageArea)))}),e.all([k.getAllVoteStatInfo(w),k.getAllVoteStatData(w),k.getAllVillageSum(w),k.getStatData(w)]).then(function(b){a.myscope.vsInfo=b[0],a.myscope.villageSum=b[2],a.myscope.villList=Object.keys(a.myscope.villageSum),a.myscope.currentTownTab=a.myscope.villList[0]})}a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var w=c.county,x=null,y=null,z=0,A=[],B=(new Date).getTime();a.myscope.county=w,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.myscope.supplementItem=k.supplementItem,a.myscope.volCount=k.volCount,a.myscope.villList=[],a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1,a.myscope.spPeopleClick=function(){a.myscope.spPeopleMore=!a.myscope.spPeopleMore},a.myscope.hpPeopleClick=function(){a.myscope.hpPeopleMore=!a.myscope.hpPeopleMore},a.leafletData=j;!function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();w in MAP_DEFAULT_BOUND||(w=DEFAULT_COUNTY);var C=function(a){return null==a?"#333333":a>=1?"#990000":a>.5?"#993333":a>0?"#aa6666":"#aaaaaa"},D=function(a){return a>.66?3:a>.33?2:1};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?0==a.myscope.showVS.vsArray.length?3:a.myscope.showVS?D(.5*(a.myscope.vsInfo[a.myscope.currentVsTab.vsId].volunteer+a.myscope.vsInfo[a.myscope.currentVsTab.vsId].supplement)):1:1};var E={weight:6,color:"white"},F={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.$emit("dataReload"),a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&t(b,c,a)})})},a.myscope.setCurrentMarkerClick=function(b,c){a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1;var d=a.markers[b];z=d.mypos,u(b),y&&(y.icon=y.myicons.x),d.icon=d.myicons.c,y=d,c&&a.leafletData.getMap().then(function(a){a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.$emit("dataReload"),a.myscope.showVS=null,y=null,z=0,a.markers={},x&&(x.setStyle(o()),x=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[w])})},a.$on("leafletDirectiveMap.geojsonMouseover",q),a.$on("leafletDirectiveMap.geojsonMouseout",r),a.$on("leafletDirectiveMap.geojsonClick",s),a.myscope.registerDialog=function(b){if("supplement"==b)var c=g.open({templateUrl:"views/closereg.html",controller:"registerCloseController",size:"md",resolve:{data:function(){return{county:w,type:b}
}}});else{var c=g.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{county:w,type:b,nonArea:!1,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName,supCount:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].sItemCount,supWeight:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].vweight}}}});c.result.then(function(){i.path("/")})}},a.myscope.reportDialog=function(){var b=g.open({templateUrl:"views/report.html",controller:"ReportCtrl",size:"md",resolve:{data:function(){return{county:w,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName}}}});b.result.then(function(){})},a.defaults={zoomControlPosition:"bottomright",scrollWheelZoom:!1,minZoom:MAP_MIN_ZOOM[w]},a.maxbounds={northEast:MAP_DEFAULT_BOUND[w][0],southWest:MAP_DEFAULT_BOUND[w][1]},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[w])}),v(!0),a.$on("dataReload",function(){var b=(new Date).getTime();b-B>MAP_RELOAD_TIME&&(B=b,a.$emit("missionDataReload"),v(!1))}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]);
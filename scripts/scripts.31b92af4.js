"use strict";angular.module("projectVApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html"}).when("/plan",{templateUrl:"views/plan.html"}).when("/demo",{templateUrl:"views/demo.html"}).when("/join",{templateUrl:"views/join.html",controller:"JoinCtrl"}).when("/mission/:county",{templateUrl:"views/mission.html",controller:"MissionCtrl"}).when("/map/:county",{templateUrl:"views/map.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("projectVApp").controller("MainCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("projectVApp").controller("JoinCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("projectVApp").controller("MissionsCtrl",["$scope",function(a){a.missions=[{id:"TPE-4",name:"TPE-4",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-1",name:"TPQ-1",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-6",name:"TPQ-6",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"}]}]),angular.module("projectVApp").controller("PagesCtrl",["$scope","$location",function(a,b){a.pages=[{id:"",name:"首頁",href:"#/"},{id:"news",name:"戰略消息"},{id:"plan",name:"罷免日計劃"},{id:"demo",name:"自由罷免示範區"},{id:"join",name:"加入公民 v 與物資支援"},{id:"facebook",name:"Facebook",target:"_blank",href:"https://www.facebook.com/Appendectomy"},{id:"email",name:"Email",target:"_blank",href:"mailto:appy.service@gmail.com"}],a.getActive=function(a){return b.url().substr(1)===a?"active":""},a.getHref=function(a){return a.href?a.href:"#/"+a.id},a.getTarget=function(a){return a.target?a.target:"_self"}}]);var DEFAULT_COUNTY="TPE-4",MAP_DEFAULT_VIEW={"TPE-4":{lat:25.0666313,lng:121.5943403,zoom:13},"TPQ-1":{lat:25.1752044,lng:121.4813232,zoom:12},"TPQ-6":{lat:25.0260396,lng:121.4654445,zoom:14}},MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]};angular.module("projectVApp").controller("MapCtrl",["$scope","$routeParams","$http","$q","$filter","$modal","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h){function i(b){a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(b)}):a.geojson={data:b,style:j,resetStyleOnMouseout:!1}}function j(a){return{opacity:1,weight:2,color:"black",dashArray:"5",fillOpacity:.7,fillColor:a.properties.mycolor,className:"county transparent"}}function k(a){return{fillColor:a}}function l(a){var b=a.feature.properties.mycolor;return k(b)}function m(){return k("#ffff00")}function n(a,b){var c=b.target;c.setStyle(z),c.bringToFront()}function o(a,b){var c=b.target;c.setStyle(A),c.bringToFront()}function p(a,b,c){var d=c.target.feature.properties.TOWNNAME,e=c.target.feature.properties.VILLAGENAM,f=c.target;q(d,e,f),r(d,e)}function q(b,c,d){w&&w.setStyle(l(w)),d.setStyle(m()),d.bringToFront(),w=d,a.leafletData.getMap().then(function(a){console.log(d.getBounds()),a.fitBounds(d.getBounds())})}function r(b,d){a.myscope.showVS={},a.myscope.showVS.townName=b,a.myscope.showVS.villageName=d,a.myscope.showVS.vsArray=[],a.markers={};var e=[],f=0,g="json/votestatInfo/"+u+".json";c.get(g).then(function(c){a.myscope.vsInfo=c.data,angular.forEach(v[b],function(c){var g=c.neighborhood.indexOf(d);-1!=g&&(a.myscope.showVS.vsArray.push({name:c.name,id:c.id}),0==e.length&&(f=c.id),e.push({vsid:c.id,townName:b,villageName:d,vspos:e.length,vscount:.5*(a.myscope.vsInfo[c.id].volunteer+a.myscope.vsInfo[c.id].supplement),vsobj:{lat:c.location.lat,lng:c.location.lng}}))}),t(e),a.myscope.setCurrentMarkerClick(f)},function(a){console.log("err",a)})}function s(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function t(b){var c={};x=null,angular.forEach(b,function(a){var b=function(){return a.vscount>.66?3:a.vscount>.33?2:1}();c[a.vsid]={lat:a.vsobj.lat,lng:a.vsobj.lng,icon:y[b].x,myicons:y[b],mycount:b,myloc:a.townName+"-"+a.villageName,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=x?d.myicons.x:d.myicons.c})}a.myscope={},a.voteInfos={};var u=b.county,v=null,w=null,x=null;a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.leafletData=g,a.taiwan=MAP_DEFAULT_VIEW[u],a.defaults={zoomControlPosition:"bottomright",minZoom:11};var y=function(){var a=[45,50],b=[a[0]/2,a[1]],c=["1","2","3"],d=["x","c","d"],e={};return angular.forEach(c,function(c){e[c]={},angular.forEach(d,function(d){e[c][d]={iconSize:a,iconUrl:"images/map"+d+c+".png",iconAnchor:b}})}),e}();u in MAP_DEFAULT_VIEW||(u=DEFAULT_COUNTY);var z={weight:5,color:"white"},A={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.TOWNNAME,e=a.feature.properties.VILLAGENAM;b==d&&c==e&&q(b,c,a)})}),r(b,c)},a.myscope.setCurrentMarkerClick=function(b){var c=a.markers[b];s(b),x&&(x.icon=x.myicons.x),c.icon=c.myicons.c,x=c},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.myscope.showVS=null,a.markers={},w&&(w.setStyle(l(w)),w=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[u])})},a.$on("leafletDirectiveMap.geojsonMouseover",n),a.$on("leafletDirectiveMap.geojsonMouseout",o),a.$on("leafletDirectiveMap.geojsonClick",p),a.myscope.registerDialog=function(b){var c=f.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{type:b,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName}}}});c.result.then(function(a){console.log("send",a)})},h.getStaticVillageData(u).then(function(){},function(){},function(a){var b=function(){return 1==a.villageSum?"#00ff00":a.villageSum>.75?"#22ee22":a.villageSum>.5?"#55dd55":a.villageSum>.25?"#88cc88":"#aaaaaa"}();a.villageArea.features[0].properties.mycolor=b,i(a.villageArea)}),h.getAllVotestatData(u).then(function(a){v=a}),h.getAllVillageSum(u).then(function(b){a.myscope.villageSum=b,a.myscope.currentTownTab=Object.keys(b)[0]}),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[u])})}]).controller("registerDialogController",["$scope","$modalInstance","data",function(a,b,c){a.title="title",a.type=c.type,a.errors="",a.content={type:c.type,votestat:c.vsName,vsid:c.vsId,name:"",phone:"",email:"",supplement:{}};var d={chair1:"椅子#1",chair2:"椅子#2",desk:"桌子",umbrella:"大傘",pens:"筆（若干）",board:"連署板"},e={name:"名字",phone:"手機",email:"E-Mail"},f=function(){var b=a.content.supplement;for(var c in d)if(b[c])return!0;return b.others_select&&b.others&&b.others.length>0?!0:!1};a.send=function(){var c=[];if(a.content.register.$invalid){var d=a.content.register;for(var g in e)d[g].$error.required&&c.push("請填寫您的"+e[g]),d[g].$error.email&&c.push("您的"+e[g]+"格式不符")}"supplement"!=a.content.type||f()||c.push("請勾選您要提供的物資"),0==c.length?b.close(a.content):(console.log("errors",c),a.errors=c.join("，"))},a.cancel=function(){b.dismiss("cancel")}}]),angular.module("projectVApp").service("voteInfoService",["$q","$http",function(a,b){var c={},d={},e={},f={};this.getAllVotestatData=function(d){function e(a){f.resolve(c[a])}var f=a.defer();if(c[d])e(d);else{var g="json/votestat/"+d+".json";b.get(g).then(function(a){c[d]=a.data,e(d)})}return f.promise},this.getAllVillageSum=function(c){function e(a){f.resolve(d[a])}var f=a.defer();return d[c]?e(c):b.get("json/villageSum/"+c+".json").then(function(a){d[c]=a.data,e(c)}),f.promise},this.getCountyVillage=function(c){function f(a,b){g.resolve({countyVillage:a,villageSum:b})}var g=a.defer();return e[c]&&d[c]?f(e[c],d[c]):this.getAllVillageSum(c).then(function(a){e[c]?f(e[c],a):b.get("json/twCountyVillage/"+c+".json").then(function(b){e[c]=b.data,f(e[c],a)})}),g.promise},this.getStaticVillageData=function(c){var d=a.defer();return this.getCountyVillage(c).then(function(a){function e(a,b,c){var e=0;h[b]&&h[b][c]&&(e=h[b][c]),d.notify({villageArea:i[a],villageSum:e,townName:b,villageName:c})}var g=a.countyVillage,h=a.villageSum;f[c]=f[c]?f[c]:{};var i=f[c];angular.forEach(g,function(a,d){angular.forEach(a,function(a){var f=c+"_"+d+"_"+a;i[f]&&e(f,d,a);var g="json/twVillage1982/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){i[f]=b,e(f,d,a)}).error(function(a){console.log(a)})})})}),d.promise}}]),angular.module("projectVApp").controller("MissionCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]);
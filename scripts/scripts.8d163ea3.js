"use strict";angular.module("projectVApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap","facebook","firebase"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/plan",{templateUrl:"views/plan.html"}).when("/demo",{templateUrl:"views/demo.html"}).when("/join",{templateUrl:"views/join.html",controller:"JoinCtrl"}).when("/mission/:county",{templateUrl:"views/mission.html",controller:"MissionCtrl"}).when("/mroute/:county",{templateUrl:"views/blank.html",controller:"MrouteCtrl"}).when("/map/:county",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/minimap/:county",{templateUrl:"views/minimap.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]).config(["FacebookProvider",function(a){var b="276159409125032";a.init(b)}]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]),angular.module("projectVApp").controller("MainCtrl",["$scope","Countdown","FINALDATE","$interval",function(a,b,c,d){a.time=b.getTime(new Date(c),new Date),d(function(){a.time=b.getTime(new Date(c),new Date)},1e3)}]),angular.module("projectVApp").controller("JoinCtrl",["$scope",function(a){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("projectVApp").controller("MissionsCtrl",["$scope","$modal",function(a,b){a.missions=[{id:"TPE-4",name:"TPE-4",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-1",name:"TPQ-1",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-6",name:"TPQ-6",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"}],a.registerDialog=function(c){var d=b.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{county:"Taiwan",type:c,nonArea:!0,vsId:"Taiwan",vsName:"Taiwan",supCount:"",supWeight:""}}}});d.result.then(function(b){console.log("send",b),a.$emit("dataReload")})}}]),angular.module("projectVApp").controller("PagesCtrl",["$scope","$location",function(a,b){-1==b.url().indexOf("minimap")&&(a.showNav=!0,a.pages=[{id:"news",name:"戰略消息",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-03.svg","class":"nav-title",cssid:"nav2"},{id:"plan",name:"罷免日計劃",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-05.svg","class":"nav-title",cssid:"nav3"},{id:"demo",name:"自由罷免示範區",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-07.svg","class":"nav-title",cssid:"nav4"},{id:"join",name:"加入公民 v 與物資支援",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-09.svg","class":"nav-title",cssid:"nav5"}],a.getActive=function(a){return b.url().substr(1)===a?"active":""},a.getHref=function(a){return a.href?a.href:"#/"+a.id},a.getTarget=function(a){return a.target?a.target:"_self"})}]);var DEFAULT_COUNTY="TPE-4",MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("MapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j){function k(){l(C)}function l(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(C.length-b.length)/C.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){l(b.slice(1))},j.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:m,resetStyleOnMouseout:!1},setTimeout(function(){l(b.slice(1))},j.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=y&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=y&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=y&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function m(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function n(a){var b=a.feature.properties.mycolor;return{fillColor:b}}function o(){return{weight:2,color:"black",dashArray:"6"}}function p(){return{weight:6,color:"yellow",dashArray:"0"}}function q(a,b){var c=b.target;c!=z&&(c.setStyle(G),c.bringToFront(),z&&z.bringToFront())}function r(a,b){var c=b.target;c!=z&&(c.setStyle(H),c.bringToFront(),z&&z.bringToFront())}function s(b,c,d){a.$emit("dataReload");var e=d.target.feature.properties.town,f=d.target.feature.properties.village,g=d.target;t(e,f,g),u(e,f,0)}function t(a,b,c){z&&z.setStyle(o()),c.setStyle(p()),c.bringToFront(),z=c}function u(b,c,d){a.myscope.showVS={},a.myscope.showVS.townName=b,a.myscope.showVS.villageName=c,a.myscope.showVS.vsArray=[],a.markers={};var e=[],f=0;angular.forEach(a.myscope.voteStatData[b],function(g){var h=g.neighborhood.indexOf(c);-1!=h&&(a.myscope.showVS.vsArray.push({name:g.name,id:g.id}),e.length==d&&(f=g.id),e.push({vsid:g.id,townName:b,villageName:c,vspos:e.length,vscount:F(.5*(a.myscope.vsInfo[g.id].volunteer+a.myscope.vsInfo[g.id].supplement)),vsobj:{lat:g.location.lat,lng:g.location.lng}}))}),e.length>0&&(w(e),a.myscope.setCurrentMarkerClick(f,!1,!1)),a.leafletData.getMap().then(function(a){var b=[];if(z){var c=z.getBounds();b.push({lat:c._northEast.lat,lng:c._northEast.lng}),b.push({lat:c._southWest.lat,lng:c._southWest.lng})}for(var d=0;d<e.length;d++)b.push({lat:e[d].vsobj.lat,lng:e[d].vsobj.lng});b.length>0&&a.fitBounds(b)})}function v(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function w(b){var c={};A=null,angular.forEach(b,function(a){var b=a.vscount;c[a.vsid]={draggable:!0,lat:a.vsobj.lat,lng:a.vsobj.lng,icon:D[b].x,myicons:D[b],mycount:b,mypos:a.vspos,myloc:a.townName+"-"+a.villageName,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.dragend",function(b,c){var d=(c.markerName,a.markers[c.markerName]);a.myscope.markerlatlng=[d.lat.toFixed(9),d.lng.toFixed(9)].join(",")}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName,!1,!0)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=A?d.myicons.x:d.myicons.c})}function x(b){j.resetDynamics(y),b&&j.getStaticVillageData(y).then(function(a){(a.county=y)&&k()},function(){},function(b){(b.county=y)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=E(b.villageSum),C.push(b.villageArea)))}),e.all([j.getAllVoteStatInfo(y),j.getAllVoteStatData(y),j.getAllVillageSum(y)]).then(function(c){a.myscope.vsInfo=c[0],a.myscope.voteStatData=c[1],a.myscope.villageSum=c[2],b?a.myscope.currentTownTab=Object.keys(a.myscope.villageSum)[0]:(a.myscope.showVS&&u(a.myscope.showVS.townName,a.myscope.showVS.villageName,B),a.leafletData.getGeoJSON().then(function(b){var c=b.getLayers();angular.forEach(c,function(b){var c=b.feature.properties.town,d=b.feature.properties.village;b.feature.properties.mycolor=E(a.myscope.villageSum[c][d]),b.setStyle(n(b)),z&&z.setStyle(p())})}))})}a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var y=c.county,z=null,A=null,B=0,C=[];a.myscope.county=y,a.myscope.voteStatData=null,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.myscope.supplementItem=j.supplementItem,a.myscope.volCount=j.volCount,a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1,a.myscope.spPeopleClick=function(){a.myscope.spPeopleMore=!a.myscope.spPeopleMore},a.myscope.hpPeopleClick=function(){a.myscope.hpPeopleMore=!a.myscope.hpPeopleMore},a.leafletData=i;var D=function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();y in MAP_DEFAULT_BOUND||(y=DEFAULT_COUNTY);var E=function(a){return a>=1?"#990000":a>.5?"#993333":a>0?"#aa6666":"#aaaaaa"},F=function(a){return a>.66?3:a>.33?2:1};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?0==a.myscope.showVS.vsArray.length?3:a.myscope.showVS?F(.5*(a.myscope.vsInfo[a.myscope.currentVsTab.vsId].volunteer+a.myscope.vsInfo[a.myscope.currentVsTab.vsId].supplement)):1:1};var G={weight:6,color:"white"},H={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.$emit("dataReload"),a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&t(b,c,a)})}),u(b,c,0)},a.myscope.setCurrentMarkerClick=function(b,c){a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1;var d=a.markers[b];B=d.mypos,v(b),A&&(A.icon=A.myicons.x),d.icon=d.myicons.c,A=d,c&&a.leafletData.getMap().then(function(a){a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.$emit("dataReload"),a.myscope.showVS=null,A=null,B=0,a.markers={},z&&(z.setStyle(o()),z=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[y])})},a.$on("leafletDirectiveMap.geojsonMouseover",q),a.$on("leafletDirectiveMap.geojsonMouseout",r),a.$on("leafletDirectiveMap.geojsonClick",s),a.myscope.registerDialog=function(b){var c=g.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{county:y,type:b,nonArea:!1,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName,supCount:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].sItemCount,supWeight:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].vweight}}}});c.result.then(function(b){console.log("send",b),a.$emit("dataReload")})},a.myscope.reload=function(){x(!1)},a.defaults={zoomControlPosition:"bottomright",minZoom:MAP_MIN_ZOOM[y]},a.maxbounds={northEast:MAP_DEFAULT_BOUND[y][0],southWest:MAP_DEFAULT_BOUND[y][1]},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[y])}),x(!0),a.$on("dataReload",function(){console.log("dataReload"),x(!1)}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]);var USE_CITIZEN_DB=!0,MY_HTTP_DELAY=200,MY_REQUERY_TIME=1e4;angular.module("projectVApp").service("voteInfoService",["$q","$http",function(a,b){this.MAP_BUFFER_TIME=10,Parse.initialize("QDCw1Ntq4E9PmPpcuwKbO2H0B1H0y77Vj1ScO9Zx","6jaJvf46pYub6Ej9IjhhIXNtZjTqRY0P4IqAJFhH");var c=Parse.Object.extend("citizen"),d=Parse.Object.extend("poll"),e=Parse.Object.extend("volunteer"),f=Parse.Object.extend("resource"),g={},h={},i={},j={},k={},l={},m={},n=this;this.supplementItem={pen:[5,"筆"],board:[5,"連署板"],water:[5,"水"],chair:[2,"椅子"],desk:[1,"桌子"],umbrella:[1,"五百萬傘"]},this.volCount=5;var o=0,p=0,q=0,r=0,s=0,t={};this.getAllVoteStatData=function(c){function d(a){o=0,e.resolve(k[a])}var e=a.defer();return o+=1,setTimeout(function(){if(k[c])d(c);else{var a="json/votestat/"+c+".json";b.get(a).then(function(a){k[c]=a.data,d(c)})}},MY_HTTP_DELAY*o),e.promise},this.getAllVillageVotestatData=function(c){function d(a){q=0,e.resolve(m[a])}var e=a.defer();return q+=1,setTimeout(function(){if(m[c])d(c);else{var a="json/villageVotestat/"+c+".json";b.get(a).then(function(a){m[c]=a.data,d(c)})}},MY_HTTP_DELAY*q),e.promise},this.getCountyVillage=function(c){function d(a,b){p=0,e.resolve({countyVillage:a,villageSum:b})}var e=a.defer();return p+=1,setTimeout(function(){j[c]&&h[c]?d(j[c],h[c]):n.getAllVillageSum(c).then(function(a){j[c]?d(j[c],a):b.get("json/twCountyVillage/"+c+".json").then(function(b){j[c]=b.data,d(j[c],a)})})},3*MY_HTTP_DELAY*p),e.promise},this.getParsedQuery=function(b,c,d,e){var f=a.defer(),g=(new Date).getTime();e||(e=1e3);var h=b+"_"+c+"_"+d+"_"+e;return t[h]&&g-t[h].time<MY_REQUERY_TIME?f.resolve(t[h].results):(b.descending("createdAt"),b.equalTo(c,d),b.limit(e),b.find({success:function(a){t[h]={time:g,results:a},f.resolve(a)},error:function(a,b){console.log("error",a,b)}})),f.promise},this.getCitizenData=function(b){function c(a){s=0,i.resolve(g[a])}function h(a,b){if(USE_CITIZEN_DB)return{county:a.get("county"),poll:a.get("poll"),resource:a.get("resource"),volunteer:a.get("volunteer")};var c={email:a.get("email"),fid:a.get("fid"),mobile:a.get("mobile"),name:a.get("name"),poll:a.get("poll"),county:a.get("county")};if("volunteer"==b){c.resource={};for(var d in n.supplementItem)c.resource[d]=0;c.volunteer=!0}else"supplement"==b&&(c.resource=a.get("resource"),c.volunteer=!1);return c}var i=a.defer();return s+=1,console.log("citizenDataHttp",s),setTimeout(function(){if(g[b])c(b);else if(USE_CITIZEN_DB){var i=new Parse.Query(d);n.getParsedQuery(i,"county",b).then(function(a){for(var d=[],e=0;e<a.length;e++)d.push(h(a[e]));g[b]=d,c(b)})}else{var j=new Parse.Query(e),k=new Parse.Query(f);a.all([n.getParsedQuery(j,"county",b),n.getParsedQuery(k,"county",b)]).then(function(a){for(var d=a[0],e=a[1],f=[],i=0;i<d.length;i++)f.push(h(d[i],"volunteer"));for(var i=0;i<e.length;i++)f.push(h(e[i],"supplement"));g[b]=f,c(b)})}},MY_HTTP_DELAY*s),i.promise},this.getTopkCitizen=function(b,c){var d=a.defer(),g=new Parse.Query(e),h=new Parse.Query(f);return a.all([n.getParsedQuery(g,"county",b,c),n.getParsedQuery(h,"county",b,c)]).then(function(a){for(var b=[],e=0;e<a[0].length;e++){var f=a[0][e];b.push({fid:f.get("fid"),createdAt:f.createdAt.getTime(),name:f.get("name"),type:"志工"})}for(var e=0;e<a[1].length;e++){var f=a[1][e];b.push({fid:f.get("fid"),createdAt:f.createdAt.getTime(),name:f.get("name"),type:"物資"})}d.resolve(b.slice(0,c))}),d.promise},this.getAllVillageSum=function(b){function c(a){r=0,d.resolve(h[a])}var d=a.defer();return r+=1,setTimeout(function(){h[b]?c(b):a.all([n.getAllVoteStatData(b),n.getCitizenData(b),n.getAllVillageVotestatData(b)]).then(function(a){var d=a[0],e=a[1],f=a[2],g={},i={};for(var j in d)for(var k=0;k<d[j].length;k++)i[d[j][k].id]=d[j][k].power;if(USE_CITIZEN_DB)for(var k=0;k<e.length;k++){var l=e[k],m=l.poll;g[m]=0;var o=l.volunteer>i[m]*n.volCount?1:l.volunteer/(i[m]*n.volCount),p=0,q=0;for(var r in n.supplementItem){var s=l.resource[r]?l.resource[r]:0;p+=s>i[m]*n.supplementItem[r][0]?1:s/(i[m]*n.supplementItem[r][0]),q+=1}g[m]=(o+p/q)/2}else{for(var k=0;k<e.length;k++){var l=e[k],m=l.poll;g[m]=g[m]?g[m]+1:1}for(var t in g)g[t]=g[t]>i[t]*n.volCount?1:g[t]/(i[t]*n.volCount)}var u={};for(var v in f){u[v]={};for(var w in f[v]){for(var x=f[v][w],y=0,k=0;k<x.length;k++)g[x[k]]&&(y+=g[x[k]]);u[v][w]=0==x.length?1:y/x.length}}h[b]=u,c(b)})},3*MY_HTTP_DELAY*r),d.promise},this.getAllVoteStatInfo=function(b){function c(a){d.resolve(i[a])}var d=a.defer();return i[b]?c(b):a.all([n.getCitizenData(b),n.getAllVoteStatData(b)]).then(function(a){var d=a[0],e=a[1],f={};for(var g in e)for(var h=0;h<e[g].length;h++){var j=e[g][h];f[j.id]={vlist:[],vCount:0,volunteer:0,slist:[],sItemCount:{},sItemSum:0,sTotalSum:0,supplement:0,address:j.address,vweight:j.power}}if(USE_CITIZEN_DB){for(var h=0;h<d.length;h++){var k=d[h],l=k.poll,m=k.resource;f[l].vCount=k.volunteer;for(var o in n.supplementItem)f[l].sItemCount[o]||(f[l].sItemCount[o]=0),m[o]&&parseInt(m[o])>0&&(f[l].sItemCount[o]=parseInt(m[o]),u=!0)}for(var p in f){var q=f[p].vweight*n.volCount;f[p].volunteer=f[p].vCount>q?1:f[p].vCount/q;var r=0,s=0;for(var o in n.supplementItem){var t=n.supplementItem[o][0]*f[p].vweight;r+=t,f[p].sItemCount[o]||(f[p].sItemCount[o]=0),s+=f[p].sItemCount[o]>=t?t:f[p].sItemCount[o]}f[p].sItemSum=s,f[p].sTotalSum=r,f[p].supplement=s>r?1:s/r}}else{for(var h=0;h<d.length;h++){var k=d[h],l=k.poll;if(f[l]){k.volunteer&&f[l].vlist.push([k.fid,k.name]);var u=!1,m=k.resource;for(var o in n.supplementItem)f[l].sItemCount[o]||(f[l].sItemCount[o]=0),m[o]&&parseInt(m[o])>0&&(f[l].sItemCount[o]+=parseInt(m[o]),u=!0);u&&f[l].slist.push([k.fid,k.name])}}for(var p in f){var q=f[p].vweight*n.volCount;f[p].volunteer=f[p].vlist.length>q?1:f[p].vlist.length/q;var r=0,s=0;for(var o in n.supplementItem){var t=n.supplementItem[o][0]*f[p].vweight;r+=t,f[p].sItemCount[o]||(f[p].sItemCount[o]=0),s+=f[p].sItemCount[o]>=t?t:f[p].sItemCount[o]}f[p].sItemSum=s,f[p].sTotalSum=r,f[p].supplement=s>r?1:s/r}}i[b]=f,c(b)}),d.promise},this.getStaticVillageData=function(c){var d=a.defer(),e=0,f=0,g=0;return this.getCountyVillage(c).then(function(a){function h(a,b,h){f+=1,setTimeout(function(){g+=1;var f=0;j[b]&&j[b][h]&&(f=j[b][h]),d.notify({villageArea:k[a],villageSum:f,loadingStatus:g/e,county:c}),g==e&&d.resolve({complete:!0,loadingStatus:g/e,county:c})},n.MAP_BUFFER_TIME*f)}var i=a.countyVillage,j=a.villageSum;l[c]=l[c]?l[c]:{};var k=l[c];angular.forEach(i,function(a,d){angular.forEach(a,function(a){e+=1;var f=c+"_"+d+"_"+a;if(k[f])h(f,d,a);else{var g="json/twVillage2010/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){k[f]=b,h(f,d,a)}).error(function(){k[f]={},console.log("loading failed",d,a),h(f,d,a)})}})})}),d.promise},this.saveCitizen=function(a,b){if(USE_CITIZEN_DB){var d=new c;d.save(a).then(function(){b()})}else if(a.volunteer){delete a.volunteer,delete a.resource;var g=new e;g.save(a).then(function(){b()})}else{delete a.volunteer;var g=new f;g.save(a).then(function(){b()})}},this.queryCitizen=function(b,c){var d=a.defer();if(USE_CITIZEN_DB)d.resolve(!1);else{var g=null;"volunteer"==c?g=new Parse.Query(e):"supplement"==c&&(g=new Parse.Query(f)),n.getParsedQuery(g,"fid",b).then(function(a){d.resolve(a.length>0?!0:!1)})}return d.promise},this.resetDynamics=function(a){g[a]&&delete g[a],h[a]&&delete h[a],i[a]&&delete i[a],j[a]&&delete j[a]}}]);var BOSS_DESCRIPTION={"TPE-4":{name:"祭止兀",img:"images/head-tsai.png"},"TPQ-6":{name:"林鴻池",img:"images/head-lin.png"},"TPQ-1":{name:"WEGO昇",img:"images/head-wu.png"}};angular.module("projectVApp").controller("MissionCtrl",["$scope","$route","$routeParams","voteInfoService","FeedService",function(a,b,c,d,e){function f(){d.getAllVoteStatInfo(g).then(function(b){var c=0,e=0,f=0,g=0;for(var h in b){var i=d.volCount*b[h].vweight;e+=i,c+=b[h].vCount>=i?i:b[h].vCount;for(var j in d.supplementItem){var k=d.supplementItem[j][0]*b[h].vweight;g+=k,f+=b[h].sItemCount[j]>=k?k:b[h].sItemCount[j]}}a.miscope.vCount=c,a.miscope.vTotal=e,a.miscope.sCount=f,a.miscope.sTotal=g})}var g=c.county,h="effect:",i="area:",j="type:",k="target:";a.miscope={},a.miscope.county=g,a.miscope.vCount=0,a.miscope.vTotal=0,a.miscope.sCount=0,a.miscope.sTotal=0,a.miscope.boss=BOSS_DESCRIPTION[g],a.miscope.newCitizen=[],a.miscope.mapLoadingComplete=!1,e.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=[],e=[],f=[];angular.forEach(c,function(a){if(angular.forEach(a.categories,function(b){0===b.indexOf(i)?a.area=b.substr(i.length):0===b.indexOf(h)?a.effect=b.substr(h.length).replace("-"," "):0===b.indexOf(j)?a.type=b.substr(j.length):0===b.indexOf(k)&&(a.target=b.substr(k.length))}),a.area||(a.area="all"),!a.type){var b=["boss","fighting"];a.type=b[Math.floor(Math.random()*b.length)]}("all"===a.area||a.area===g)&&d.push(a)}),angular.forEach(d,function(a){"boss"===a.target?e.push(a):"citizen"===a.target&&f.push(a)}),console.log(c),a.bossFeeds=angular.copy(e),a.citizenFeeds=angular.copy(f)}),f(),a.$on("dataReload",function(){f()}),a.miscope.missionAdd=function(){$("html, body").animate({scrollTop:$("#mission_map_title").offset().top},500)}}]),angular.module("projectVApp").controller("registerDialogController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data",function(a,b,c,d,e,f){function g(b){a.$apply("connected"==b.status?function(){a.logged=!0,a.me()}:function(){a.logged=!1,a.editState=0,a.unregster=0,a.user={}})}function h(a){return/^\+?(0|[1-9]\d*)$/.test(a)}function i(){var b={fid:parseInt(a.content.userid),volunteer:"volunteer"==a.content.type,poll:f.vsId,name:a.content.name,mobile:a.content.phone,email:a.content.email,county:f.county,resource:a.content.supplement};e.saveCitizen(b,function(){c.close(a.content)})}function j(){var a="割闌尾V計劃網站測試中\n http://1129vday.tw/";d.api("/me/feed","post",{message:a},function(a){!a||a.error?console.log("error",a.error):console.log("Post ID: "+a.id)})}a.regscope={},a.user={},a.logged=!1,a.unregster=0,a.editState=0,a.facebookReady=!1,a.$watch(function(){return d.isReady()},function(b){b&&(a.facebookReady=!0)});var k=!1;a.intentLogin=function(){k||a.login()},a.login=function(){d.login(function(a){g(a)},{scope:"publish_stream,publish_actions"})},a.me=function(){d.api("/me",function(b){a.$apply(function(){a.user=b})})},a.logout=function(){d.logout(function(){a.$apply(function(){a.user={},a.logged=!1,a.unregster=0,a.editState=0,a.regscope.errors="",k=!1})})},a.$on("Facebook:statusChange",function(a,b){g(b)}),d.getLoginStatus(function(a){g(a),"connected"==a.status&&(k=!0)}),a.regscope.selectItems=e.supplementItem;var l=a.regscope.selectItems;a.regscope.fbshare=!0,a.regscope.type=f.type,a.regscope.nonArea=f.nonArea,a.regscope.supCount=f.supCount,a.regscope.supWeight=f.supWeight,a.regscope.errors="",a.regscope.newuser=!0,a.content={type:f.type,votestat:f.vsName,vsid:f.vsId,userid:"",name:"",phone:"",email:"",supplement:{}};for(var m in l)a.content.supplement[m]=0;a.$watch("user",function(b){if(b&&b.id){a.content.userid=b.id,a.content.name=b.name,a.content.phone="",a.content.email="",a.content.supplement={};for(var c in l)a.content.supplement[c]=0;e.queryCitizen(b.id,f.type).then(function(b){a.unregster=b?1:2})}},!0);var n={phone:"手機",email:"E-Mail"},o=function(){var b=a.content.supplement;for(var c in l)if(!h(b[c]))return[!1,"物資數量填寫錯誤"];for(var c in l)if(b[c]>0)return[!0,""];return b.others_select&&b.others&&b.others.length>0?[!0,""]:[!1,"請填選您要提供的物資"]};a.send=function(){var b=[];if(a.content.register.$invalid){var c=a.content.register;for(var d in n)c[d].$error.required&&b.push("請填寫您的"+n[d]),c[d].$error.email&&b.push("您的"+n[d]+"格式不符")}var e=o();"supplement"!=a.content.type||e[0]||b.push(e[1]),0==b.length?0==a.editState?a.editState+=1:(1==a.regscope.fbshare&&j(),i()):a.regscope.errors=b.join("，")},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").factory("FeedService",["$http",function(a){return{parseFeed:function(b){return a.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(b+"?"+(new Date).getTime()))}}}]),angular.module("projectVApp").controller("NewsCtrl",["$scope","FeedService","Countdown","FINALDATE","$interval",function(a,b,c,d,e){b.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=[];angular.forEach(b.data.responseData.feed.entries,function(a){c.push(a),angular.forEach(a.categories,function(b){0===b.indexOf("tag:")&&(a.tag=b.substr("tag:".length))}),a.tag||(a.tag="最新消息")}),a.feeds=c}),a.time=c.getTime(new Date(d),new Date),e(function(){a.time=c.getTime(new Date(d),new Date)},1e3)}]),angular.module("projectVApp").service("Countdown",function(){return{getTime:function(a,b){var c=a-b,d=parseInt(c/1e3/60/60),e=parseInt(c/6e4-60*d),f=parseInt(c/1e3%60),g=parseInt(5*f/3);return{hours:d,minutes:e,seconds:f,ratio:g}}}}),angular.module("projectVApp").constant("FINALDATE","2014/11/29"),angular.module("projectVApp").controller("MrouteCtrl",["$scope","$routeParams","$location",function(a,b,c){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var d=b.county;c.path("/mission/"+d)}]);
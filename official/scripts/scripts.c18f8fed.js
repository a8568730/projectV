"use strict";angular.module("projectVApp",["ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch","leaflet-directive","ui.bootstrap","facebook","firebase"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/news",{templateUrl:"views/news.html",controller:"NewsCtrl"}).when("/plan",{templateUrl:"views/plan.html"}).when("/demo",{templateUrl:"views/demo.html"}).when("/petition",{templateUrl:"views/petition.html",controller:"PetitionCtrl"}).when("/mission/:county",{templateUrl:"views/mission.html",controller:"MissionCtrl"}).when("/mroute/:county",{templateUrl:"views/blank.html",controller:"MrouteCtrl"}).when("/map/:county",{templateUrl:"views/map.html",controller:"MapCtrl"}).when("/minimap/:county",{templateUrl:"views/minimap.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]).config(["FacebookProvider",function(a){var b="882033105143189";a.init(b)}]).filter("percentage",["$filter",function(a){return function(b,c){return a("number")(100*b,c)+"%"}}]),angular.module("projectVApp").controller("MainCtrl",["$scope","Countdown","FINALDATE","$interval",function(a,b,c,d){a.time=b.getTime(new Date(c),new Date),d(function(){a.time=b.getTime(new Date(c),new Date)},1e3)}]),angular.module("projectVApp").controller("PetitionCtrl",["$scope",function(){}]),angular.module("projectVApp").controller("MissionsCtrl",["$scope","$modal",function(a,b){a.missions=[{id:"TPE-4",name:"TPE-4",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-1",name:"TPQ-1",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"},{id:"TPQ-6",name:"TPQ-6",description:"童些趣錯事立報式而變受……論技麼康應居孩了定同大李本天心備，方告那下好當放一的科不復多神分發自原事慢費日華國心風出和夜大"}],a.registerDialog=function(c){var d=b.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{county:"Taiwan",type:c,nonArea:!0,vsId:"Taiwan",vsName:"Taiwan",supCount:"",supWeight:""}}}});d.result.then(function(b){console.log("send",b),a.$emit("dataReload")})}}]),angular.module("projectVApp").controller("PagesCtrl",["$scope","$location",function(a,b){-1==b.url().indexOf("minimap")&&(a.showNav=!0,a.pages=[{id:"news",name:"戰略消息",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-03.svg","class":"nav-title",cssid:"nav2"},{id:"plan",name:"罷免日計劃",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-05.svg","class":"nav-title",cssid:"nav3"},{id:"demo",name:"自由罷免示範區",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-07.svg","class":"nav-title",cssid:"nav4"},{id:"petition",name:"連署書資訊",img:"https://s3-ap-southeast-1.amazonaws.com/1129vday.tw/img/1129-09.svg","class":"nav-title",cssid:"nav5"}],a.getActive=function(a){return b.url().substr(1)===a?"active":""},a.getHref=function(a){return a.href?a.href:"#/"+a.id},a.getTarget=function(a){return a.target?a.target:"_self"})}]);var DEFAULT_COUNTY="TPE-4",MAP_RELOAD_TIME=1e4,MAP_DEFAULT_BOUND={"TPE-4":[{lat:25.1151655,lng:121.6659156},{lat:25.0122295,lng:121.5521896}],"TPQ-1":[{lat:25.301133,lng:121.6195265},{lat:25.0287778,lng:121.2826487}],"TPQ-6":[{lat:25.0398178,lng:121.4895901},{lat:25.0034634,lng:121.4451953}]},MAP_MIN_ZOOM={"TPE-4":13,"TPQ-1":11,"TPQ-6":14};angular.module("projectVApp").controller("MapCtrl",["$scope","$route","$routeParams","$http","$q","$filter","$modal","$window","$location","leafletData","voteInfoService",function(a,b,c,d,e,f,g,h,i,j,k){function l(){m(D)}function m(b){var c=b[0];return a.myscope.mapLoadingStatus=.2+(D.length-b.length)/D.length*.8,c?void(a.geojson?a.leafletData.getGeoJSON().then(function(a){a.addData(c),setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME)}):(a.geojson={data:c,style:n,resetStyleOnMouseout:!1},setTimeout(function(){m(b.slice(1))},k.MAP_BUFFER_TIME))):(a.myscope.mapLoadingStatus=1,$(".myLoading").fadeOut("slow",function(){$(".myLoading").remove(),"TPE-4"!=z&&$("#mroute-TPE-4").css({visibility:"visible"}),"TPQ-6"!=z&&$("#mroute-TPQ-6").css({visibility:"visible"}),"TPQ-1"!=z&&$("#mroute-TPQ-1").css({visibility:"visible"})}),void(a.myscope.mapLoadingComplete=!0))}function n(a){return{opacity:1,weight:2,color:"black",dashArray:"6",fillOpacity:.5,fillColor:a.properties.mycolor,className:"county transparent"}}function o(a){var b=a.feature.properties.mycolor;return{fillColor:b}}function p(){return{weight:2,color:"black",dashArray:"6"}}function q(){return{weight:6,color:"yellow",dashArray:"0"}}function r(a,b){var c=b.target;c!=A&&(c.setStyle(I),c.bringToFront(),A&&A.bringToFront())}function s(a,b){var c=b.target;c!=A&&(c.setStyle(J),c.bringToFront(),A&&A.bringToFront())}function t(b,c,d){a.$emit("dataReload");var e=d.target.feature.properties.town,f=d.target.feature.properties.village,g=d.target;u(e,f,g),v(e,f,0)}function u(a,b,c){A&&A.setStyle(p()),c.setStyle(q()),c.bringToFront(),A=c}function v(b,c,d){a.myscope.showVS={},a.myscope.showVS.townName=b,a.myscope.showVS.villageName=c,a.myscope.showVS.vsArray=[],a.markers={};var e=[],f=0;angular.forEach(a.myscope.voteStatData[b],function(g){var h=g.neighborhood.indexOf(c);-1!=h&&(a.myscope.showVS.vsArray.push({name:g.name,id:g.id}),e.length==d&&(f=g.id),e.push({vsid:g.id,townName:b,villageName:c,vspos:e.length,vscount:H(.5*(a.myscope.vsInfo[g.id].volunteer+a.myscope.vsInfo[g.id].supplement)),vsobj:{lat:g.location.lat,lng:g.location.lng}}))}),e.length>0&&(x(e),a.myscope.setCurrentMarkerClick(f,!1,!1)),a.leafletData.getMap().then(function(a){var b=[];if(A){var c=A.getBounds();b.push({lat:c._northEast.lat,lng:c._northEast.lng}),b.push({lat:c._southWest.lat,lng:c._southWest.lng})}for(var d=0;d<e.length;d++)b.push({lat:e[d].vsobj.lat,lng:e[d].vsobj.lng});b.length>0&&a.fitBounds(b)})}function w(b){a.myscope.currentVsTab.vsId=b,a.myscope.currentVsTab.vsName=function(){for(var c=0;c<a.myscope.showVS.vsArray.length;c++){var d=a.myscope.showVS.vsArray[c];if(d.id==b)return d.name}}()}function x(b){var c={};B=null,angular.forEach(b,function(a){var b=a.vscount;c[a.vsid]={draggable:!0,lat:a.vsobj.lat,lng:a.vsobj.lng,icon:F[b].x,myicons:F[b],mycount:b,mypos:a.vspos,myloc:a.townName+"-"+a.villageName,myid:a.vsid}}),angular.extend(a,{markers:c}),a.$on("leafletDirectiveMarker.dragend",function(b,c){var d=(c.markerName,a.markers[c.markerName]);a.myscope.markerlatlng=[d.lat.toFixed(9),d.lng.toFixed(9)].join(",")}),a.$on("leafletDirectiveMarker.click",function(b,c){a.myscope.setCurrentMarkerClick(c.markerName,!1,!0)}),a.$on("leafletDirectiveMarker.mouseover",function(b,c){var d=a.markers[c.markerName];d.icon=d.myicons.d}),a.$on("leafletDirectiveMarker.mouseout",function(b,c){var d=(c.markerName,a.markers[c.markerName]);d.icon=d!=B?d.myicons.x:d.myicons.c})}function y(b){k.resetDynamics(z),b&&k.getStaticVillageData(z).then(function(a){(a.county=z)&&l()},function(){},function(b){(b.county=z)&&(a.myscope.mapLoadingStatus=.2*b.loadingStatus,jQuery.isEmptyObject(b.villageArea)||(b.villageArea.features[0].properties.mycolor=G(b.villageSum),D.push(b.villageArea)))}),e.all([k.getAllVoteStatInfo(z),k.getAllVoteStatData(z),k.getAllVillageSum(z)]).then(function(c){a.myscope.vsInfo=c[0],a.myscope.voteStatData=c[1],a.myscope.villageSum=c[2],b?a.myscope.currentTownTab=Object.keys(a.myscope.villageSum)[0]:(a.myscope.showVS&&v(a.myscope.showVS.townName,a.myscope.showVS.villageName,C),a.leafletData.getGeoJSON().then(function(b){var c=b.getLayers();angular.forEach(c,function(b){var c=b.feature.properties.town,d=b.feature.properties.village;b.feature.properties.mycolor=G(a.myscope.villageSum[c][d]),b.setStyle(o(b)),A&&A.setStyle(q())})}))})}a.myscope={},a.myscope.mapLoadingComplete=!1,a.myscope.mapLoadingStatus=!1;var z=c.county,A=null,B=null,C=0,D=[],E=(new Date).getTime();a.myscope.county=z,a.myscope.voteStatData=null,a.myscope.showVS=null,a.myscope.currentVsTab={},a.myscope.currentTownTab="",a.myscope.vsInfo={},a.myscope.supplementItem=k.supplementItem,a.myscope.volCount=k.volCount,a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1,a.myscope.spPeopleClick=function(){a.myscope.spPeopleMore=!a.myscope.spPeopleMore},a.myscope.hpPeopleClick=function(){a.myscope.hpPeopleMore=!a.myscope.hpPeopleMore},a.leafletData=j;var F=function(){var a=[60,100],b=[30,10],c=[a[0]/2,a[1]],d=[b[0]/2,b[1]/2],e=["1","2","3"],f=["x","c","d"],g={};return angular.forEach(e,function(e){g[e]={},angular.forEach(f,function(f){g[e][f]={iconSize:a,iconAnchor:c,iconUrl:"images/map"+f+e+".svg",shadowSize:b,shadowAnchor:d,shadowUrl:"images/map_icon_shadow.svg"}})}),g}();z in MAP_DEFAULT_BOUND||(z=DEFAULT_COUNTY);var G=function(a){return a>=1?"#990000":a>.5?"#993333":a>0?"#aa6666":"#aaaaaa"},H=function(a){return a>.66?3:a>.33?2:1};a.myscope.getVoteStatImg=function(){return a.myscope.showVS?0==a.myscope.showVS.vsArray.length?3:a.myscope.showVS?H(.5*(a.myscope.vsInfo[a.myscope.currentVsTab.vsId].volunteer+a.myscope.vsInfo[a.myscope.currentVsTab.vsId].supplement)):1:1};var I={weight:6,color:"white"},J={weight:2,color:"black"};a.myscope.setCurrentAreaClick=function(b,c){a.$emit("dataReload"),a.leafletData.getGeoJSON().then(function(a){var d=a.getLayers();angular.forEach(d,function(a){var d=a.feature.properties.town,e=a.feature.properties.village;b==d&&c==e&&u(b,c,a)})}),v(b,c,0)},a.myscope.setCurrentMarkerClick=function(b,c){a.myscope.spPeopleMore=!1,a.myscope.hpPeopleMore=!1;var d=a.markers[b];C=d.mypos,w(b),B&&(B.icon=B.myicons.x),d.icon=d.myicons.c,B=d,c&&a.leafletData.getMap().then(function(a){a.setView({lat:d.lat,lng:d.lng})})},a.myscope.setTownTab=function(b){a.myscope.currentTownTab=b},a.myscope.isCurrentTownTab=function(b){return a.myscope.currentTownTab==b?"bg-primary":""},a.myscope.isCurrentVsTab=function(b){return a.myscope.currentVsTab.vsId==b?"bg-primary":""},a.debug=function(){},a.myscope.back=function(){a.$emit("dataReload"),a.myscope.showVS=null,B=null,C=0,a.markers={},A&&(A.setStyle(p()),A=null),a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])})},a.$on("leafletDirectiveMap.geojsonMouseover",r),a.$on("leafletDirectiveMap.geojsonMouseout",s),a.$on("leafletDirectiveMap.geojsonClick",t),a.myscope.registerDialog=function(b){var c=g.open({templateUrl:"views/register.html",controller:"registerDialogController",size:"md",resolve:{data:function(){return{county:z,type:b,nonArea:!1,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName,supCount:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].sItemCount,supWeight:a.myscope.vsInfo[a.myscope.currentVsTab.vsId].vweight}}}});c.result.then(function(){i.path("/")})},a.myscope.reportDialog=function(){var b=g.open({templateUrl:"views/report.html",controller:"ReportCtrl",size:"md",resolve:{data:function(){return{county:z,vsId:a.myscope.currentVsTab.vsId,vsName:a.myscope.currentVsTab.vsName}}}});b.result.then(function(){})},a.defaults={zoomControlPosition:"bottomright",minZoom:MAP_MIN_ZOOM[z]},a.maxbounds={northEast:MAP_DEFAULT_BOUND[z][0],southWest:MAP_DEFAULT_BOUND[z][1]},a.leafletData.getMap().then(function(a){a.fitBounds(MAP_DEFAULT_BOUND[z])}),y(!0),a.$on("dataReload",function(){var a=(new Date).getTime();a-E>MAP_RELOAD_TIME&&(E=a,console.log("dataReload"))}),angular.extend(a,{layers:{baselayers:{googleRoadmap:{name:"Google Streets",layerType:"ROADMAP",type:"google"}}}})}]);var MY_HTTP_DELAY=200,MY_HTTP_RETRY=3e3,MY_REQUERY_TIME=1e4;angular.module("projectVApp").service("voteInfoService",["$q","$http",function(a,b){function c(c,d){function e(a){s[c]=0,f.resolve(r[c][a])}var f=a.defer();if(s[c]+=1,s[c]>1)var g=setInterval(function(){console.log("repeat "+c),r[c][d]&&(clearInterval(g),e(d))},MY_HTTP_DELAY);else if(r[c][d])e(d);else{var h=function(){var a="json/"+c+"/"+d+".json";console.log("query"+c),b.get(a).success(function(a){r[c][d]=a,e(d)}).error(function(){setTimeout(function(){h()},MY_HTTP_RETRY)})};h()}return f.promise}this.MAP_BUFFER_TIME=10,Parse.initialize("QDCw1Ntq4E9PmPpcuwKbO2H0B1H0y77Vj1ScO9Zx","6jaJvf46pYub6Ej9IjhhIXNtZjTqRY0P4IqAJFhH");var d=Parse.Object.extend("citizen"),e=Parse.Object.extend("poll"),f=Parse.Object.extend("volunteer"),g=Parse.Object.extend("resource"),h=Parse.Object.extend("report"),i={},j={},k={},l={},m=this;this.supplementItem={pen:[5,"筆"],board:[5,"連署板"],water:[5,"水"],chair:[2,"椅子"],desk:[1,"桌子"],umbrella:[1,"五百萬傘"]},this.volCount=5;var n=0,o=0,p=0,q={},r={votestat:{},villageVotestat:{},twCountyVillage:{}},s={votestat:0,villageVotestat:0,twCountyVillage:0};this.getAllVoteStatData=function(a){return c("votestat",a)},this.getAllVillageVotestatData=function(a){return c("villageVotestat",a)},this.getCountyVillage=function(a){return c("twCountyVillage",a)},this.getParsedQuery=function(b,c,d,e){function f(a){q[a].count=0,g.resolve(q[a].results)}var g=a.defer(),h=b+"_"+c+"_"+d+"_"+e;q[h]||(q[h]={count:0}),q[h].count+=1;var i=(new Date).getTime();if(e||(e=1e3),q[h].time&&i-q[h].time<MY_REQUERY_TIME)f(h);else if(q[h].count>1)var j=setInterval(function(){console.log("repeat query"),q[h].results&&(clearInterval(j),f(h))},MY_HTTP_DELAY);else{var k=function(){console.log("repeat 2 query interval"),b.descending("createdAt"),b.equalTo(c,d),b.limit(e),b.find({success:function(a){q[h]={time:i,results:a,count:0},g.resolve(a)},error:function(){setTimeout(function(){k()},MY_HTTP_RETRY)}})};k()}return g.promise},this.getCitizenData=function(b){function c(a){o=0,f.resolve(i[a])}function d(a){var b=a.get("resourceBody")?angular.copy(a.get("resourceBody")).reverse():[],c=a.get("volunteerBody")?angular.copy(a.get("volunteerBody")).reverse():[];return{county:a.get("county"),poll:a.get("poll"),resource:a.get("resource"),volunteer:a.get("volunteer"),resourceBody:b,volunteerBody:c}}var f=a.defer();if(o+=1,i[b])c(b);else if(o>1)var g=setInterval(function(){console.log("repeat citizen data"),i[b]&&(clearInterval(g),c(b))},MY_HTTP_DELAY);else{console.log("run citizen data");var h=new Parse.Query(e);m.getParsedQuery(h,"county",b).then(function(a){for(var e=[],f=0;f<a.length;f++)e.push(d(a[f]));i[b]=e,c(b)})}return f.promise},this.getTopkCitizen=function(b,c){var d=a.defer(),e=new Parse.Query(f),h=new Parse.Query(g);return a.all([m.getParsedQuery(e,"county",b,c),m.getParsedQuery(h,"county",b,c)]).then(function(a){for(var b=[],e=0;e<a[0].length;e++){var f=a[0][e];b.push({fid:f.get("fid"),createdAt:f.createdAt.getTime(),name:f.get("name"),type:"志工"})}for(var e=0;e<a[1].length;e++){var f=a[1][e];b.push({fid:f.get("fid"),createdAt:f.createdAt.getTime(),name:f.get("name"),type:"物資"})}d.resolve(b.slice(0,c))}),d.promise},this.getAllVillageSum=function(b){function c(a){n=0,d.resolve(j[a])}var d=a.defer();if(n+=1,j[b])c(b);else if(n>1)var e=setInterval(function(){console.log("repeat villageSumHttp"),j[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else console.log("run villageSumHttp"),a.all([m.getAllVoteStatData(b),m.getCitizenData(b),m.getAllVillageVotestatData(b)]).then(function(a){var d=a[0],e=a[1],f=a[2],g={},h={};for(var i in d)for(var k=0;k<d[i].length;k++)h[d[i][k].id]=d[i][k].power;for(var k=0;k<e.length;k++){var l=e[k],n=l.poll;g[n]=0;var o=l.volunteer>h[n]*m.volCount?1:l.volunteer/(h[n]*m.volCount),p=0,q=0;for(var r in m.supplementItem){var s=l.resource[r]?l.resource[r]:0;p+=s>h[n]*m.supplementItem[r][0]?1:s/(h[n]*m.supplementItem[r][0]),q+=1}g[n]=(o+p/q)/2}var t={};for(var u in f){t[u]={};for(var v in f[u]){for(var w=f[u][v],x=0,k=0;k<w.length;k++)g[w[k]]&&(x+=g[w[k]]);t[u][v]=0==w.length?1:x/w.length}}j[b]=t,c(b)});return d.promise},this.getAllVoteStatInfo=function(b){function c(a){p=0,d.resolve(k[a])}var d=a.defer();if(p+=1,k[b])c(b);else if(p>1)var e=setInterval(function(){console.log("repeat allVoteStatInfoHttp"),k[b]&&(clearInterval(e),c(b))},3*MY_HTTP_DELAY);else console.log("run allVoteStatInfoHttp"),a.all([m.getCitizenData(b),m.getAllVoteStatData(b)]).then(function(a){var d=a[0],e=a[1],f={};for(var g in e)for(var h=0;h<e[g].length;h++){var i=e[g][h];f[i.id]={vlist:[],vCount:0,volunteer:0,slist:[],sItemCount:{},sItemSum:0,sTotalSum:0,supplement:0,address:i.address,vweight:i.power}}for(var h=0;h<d.length;h++){var j=d[h],l=j.poll,n=j.resource;f[l].vCount=j.volunteer,f[l].vlist=j.volunteerBody,f[l].slist=j.resourceBody;for(var o in m.supplementItem)f[l].sItemCount[o]||(f[l].sItemCount[o]=0),n[o]&&parseInt(n[o])>0&&(f[l].sItemCount[o]=parseInt(n[o]))}for(var p in f){var q=f[p].vweight*m.volCount;f[p].volunteer=f[p].vCount>q?1:f[p].vCount/q;var r=0,s=0;for(var o in m.supplementItem){var t=m.supplementItem[o][0]*f[p].vweight;r+=t,f[p].sItemCount[o]||(f[p].sItemCount[o]=0),s+=f[p].sItemCount[o]>=t?t:f[p].sItemCount[o]}f[p].sItemSum=s,f[p].sTotalSum=r,f[p].supplement=s>r?1:s/r}k[b]=f,c(b)});return d.promise},this.getStaticVillageData=function(c){var d=a.defer(),e=0,f=0,g=0;return a.all([m.getCountyVillage(c),m.getAllVillageSum(c)]).then(function(a){function h(a,b,h){f+=1,setTimeout(function(){g+=1;var f=0;j[b]&&j[b][h]&&(f=j[b][h]),d.notify({villageArea:k[a],villageSum:f,loadingStatus:g/e,county:c}),g==e&&d.resolve({complete:!0,loadingStatus:g/e,county:c})},m.MAP_BUFFER_TIME*f)}var i=a[0],j=a[1];l[c]=l[c]?l[c]:{};var k=l[c];angular.forEach(i,function(a,d){angular.forEach(a,function(a){e+=1;var f=c+"_"+d+"_"+a;if(k[f])h(f,d,a);else{var g="json/twVillage2010/"+c+"/"+d+"/"+a+".json";b.get(g).success(function(b){k[f]=b,h(f,d,a)}).error(function(){k[f]={},h(f,d,a)})}})})}),d.promise},this.saveCitizen=function(a,b){var c=new d;c.save(a).then(function(){b()})},this.saveReport=function(a,b){var c=new h;c.save(a).then(function(){b()})},this.queryCitizen=function(){var b=a.defer();return b.resolve(!1),b.promise},this.resetDynamics=function(a){i[a]&&delete i[a],j[a]&&delete j[a],k[a]&&delete k[a]}}]);var BOSS_DESCRIPTION={"TPE-4":{name:"祭止兀",img:"images/head-tsai.png"},"TPQ-6":{name:"林鴻池",img:"images/head-lin.png"},"TPQ-1":{name:"WEGO昇",img:"images/head-wu.png"}};angular.module("projectVApp").controller("MissionCtrl",["$scope","$route","$routeParams","voteInfoService","FeedService",function(a,b,c,d,e){function f(){d.getAllVoteStatInfo(g).then(function(b){var c=0,e=0,f=0,g=0;for(var h in b){var i=d.volCount*b[h].vweight;e+=i,c+=b[h].vCount>=i?i:b[h].vCount;for(var j in d.supplementItem){var k=d.supplementItem[j][0]*b[h].vweight;g+=k,f+=b[h].sItemCount[j]>=k?k:b[h].sItemCount[j]}}a.miscope.vCount=c,a.miscope.vTotal=e,a.miscope.sCount=f,a.miscope.sTotal=g})}var g=c.county,h="effect:",i="area:",j="type:",k=/「(.+)」.*by(.*)。/i;a.miscope={},a.miscope.county=g,a.miscope.vCount=0,a.miscope.vTotal=0,a.miscope.sCount=0,a.miscope.sTotal=0,a.miscope.boss=BOSS_DESCRIPTION[g],a.miscope.newCitizen=[],a.miscope.mapLoadingComplete=!1,e.parseFeed("http://appyv.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=c[Math.floor(Math.random()*c.length)],e=d.content.match(k),f=new DOMParser,g=f.parseFromString(d.content,"text/html");if(e){a.speech=e[1],a.citizen=e[2];var h=g.querySelector("img");h&&(a.citizenAvatar={"background-image":"url("+h.src+")"})}}),e.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=b.data.responseData.feed.entries,d=[],e=[],f=[],k=6;angular.forEach(c,function(a){angular.forEach(a.categories,function(b){0===b.indexOf(i)?a.area=b.substr(i.length):0===b.indexOf(h)?a.effect=b.substr(h.length).replace("-"," "):0===b.indexOf(j)&&(a.type=b.substr(j.length))}),a.area||(a.area="all"),("all"===a.area||a.area===g)&&d.push(a)}),angular.forEach(d,function(a){"boss"===a.type?e.length<k&&e.push(a):a.type&&"v"!==a.type&&f.length<k&&f.push(a)}),console.log(c),a.bossFeeds=angular.copy(e),a.citizenFeeds=angular.copy(f)}),f(),a.$on("missionDataReload",function(){console.log("mission load data"),f()}),a.miscope.missionAdd=function(){$("html, body").animate({scrollTop:$("#mission_map_title").offset().top},500)}}]),angular.module("projectVApp").controller("registerDialogController",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data",function(a,b,c,d,e,f){function g(b){a.$apply("connected"==b.status?function(){a.me()}:function(){a.logged=!1,l=!1,a.fbname="",a.editState=0,a.unregster=0})}function h(b){if(b&&b.id){a.content.userid=b.id,a.content.name=b.name,a.fbname=b.name,a.content.phone="",a.content.email="",a.content.areaOrder=[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],a.content.supplement={};for(var c in m)a.content.supplement[c]=0;e.queryCitizen(b.id,f.type).then(function(b){a.unregster=b?1:2})}else a.me()}function i(a){return/^\+?(0|[1-9]\d*)$/.test(a)}function j(){var b={fid:parseInt(a.content.userid),volunteer:"volunteer"==a.content.type,poll:f.vsId,name:a.content.name,mobile:a.content.phone,email:a.content.email,county:f.county,resource:a.content.supplement};a.regscope.nonArea&&(b.areaOrder=a.content.areaOrder.join(",")),e.saveCitizen(b,function(){a.editState=3})}function k(){var a="割闌尾V計劃網站測試中";d.api("/me/feed","post",{message:a,link:"http://1129vday.tw/"},function(a){!a||a.error})}a.regscope={},a.logged=!1,a.fbname="",a.unregster=0,a.editState=0,a.facebookReady=!1,a.$watch(function(){return d.isReady()},function(b){b&&(a.facebookReady=!0)});var l=!1;a.intentLogin=function(){a.login()},a.login=function(){d.login(function(a){g(a)},{scope:"publish_stream,publish_actions"})},a.me=function(){d.api("/me",function(b){a.$apply(function(){h(b),a.logged=!0,l=!0})})},a.logout=function(){d.logout(function(){a.$apply(function(){a.logged=!1,l=!1,a.fbname="",a.unregster=0,a.editState=0,a.regscope.errors=""})})},a.$on("Facebook:statusChange",function(a,b){g(b)}),d.getLoginStatus(function(a){g(a)}),a.regscope.selectItems=e.supplementItem;var m=a.regscope.selectItems;a.regscope.nonAreaSelect=["台北市","新北市","台中市","台南市","高雄市"],a.regscope.fbshare=!0,a.regscope.type=f.type,a.regscope.nonArea=f.nonArea,a.regscope.supCount=f.supCount,a.regscope.supWeight=f.supWeight,a.regscope.errors="",a.regscope.newuser=!0,a.content={type:f.type,votestat:f.vsName,vsid:f.vsId,userid:"",name:"",phone:"",email:"",areaOrder:[a.regscope.nonAreaSelect[0],a.regscope.nonAreaSelect[1],a.regscope.nonAreaSelect[2]],supplement:{}};for(var n in m)a.content.supplement[n]=0;var o={name:"暱稱",phone:"手機",email:"E-Mail"},p=function(){var b=a.content.supplement;for(var c in m)if(!i(b[c]))return[!1,"物資數量填寫錯誤"];for(var c in m)if(b[c]>0)return[!0,""];return[!1,"請填選您要提供的物資"]};a.send=function(){var b=[];if(a.content.register.$invalid){var d=a.content.register;for(var e in o)d[e].$error.required&&b.push("請填寫您的"+o[e]),d[e].$error.email&&b.push("您的"+o[e]+"格式不符")}var f=p();"supplement"!=a.content.type||f[0]||b.push(f[1]),0==b.length?0==a.editState?a.editState=1:1==a.editState?(a.editState=2,1==a.regscope.fbshare&&k(),j()):3==a.editState&&c.close(!0):a.regscope.errors=b.join("，")},a.cancel=function(){c.dismiss("cancel")}}]),angular.module("projectVApp").factory("FeedService",["$http",function(a){return{parseFeed:function(b){return a.jsonp("//ajax.googleapis.com/ajax/services/feed/load?v=1.0&num=50&callback=JSON_CALLBACK&q="+encodeURIComponent(b+"?"+(new Date).getTime()))}}}]),angular.module("projectVApp").controller("NewsCtrl",["$scope","FeedService","Countdown","FINALDATE","$interval",function(a,b,c,d,e){var f={street:"掃街活動",speech:"宣講活動",music:"音樂活動",multiple:"綜合活動",hide:"隱藏活動",boss:"魔王消息"};b.parseFeed("http://appytw.tumblr.com/rss").then(function(b){var c=[];angular.forEach(b.data.responseData.feed.entries,function(a){c.push(a),angular.forEach(a.categories,function(b){if(0===b.indexOf("type:")){var c=b.substr("type:".length);a.type=c,a.tag=f[c]}}),a.tag||(a.tag="最新消息",a.type="multiple")}),a.feeds=c}),a.time=c.getTime(new Date(d),new Date),e(function(){a.time=c.getTime(new Date(d),new Date)},1e3)}]),angular.module("projectVApp").service("Countdown",function(){return{getTime:function(a,b){var c=a-b,d=parseInt(c/1e3/60/60),e=parseInt(c/6e4-60*d),f=parseInt(c/1e3%60),g=parseInt(5*f/3);return{hours:d,minutes:e,seconds:f,ratio:g}}}}),angular.module("projectVApp").constant("FINALDATE","2014/11/29"),angular.module("projectVApp").controller("MrouteCtrl",["$scope","$routeParams","$location",function(a,b,c){a.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"];var d=b.county;c.path("/mission/"+d)}]),angular.module("projectVApp").controller("ReportCtrl",["$scope","$timeout","$modalInstance","Facebook","voteInfoService","data",function(a,b,c,d,e,f){a.errortype=["投開票所在地圖上標錯位置","投開票所名稱有誤","投開票所地址有誤","投開票所的所屬里有誤","此投開票所不存在","其他"],a.hassave=!1,a.report={county:f.county,poll:f.vsId,type:a.errortype[0],content:""},a.save=function(){a.hassave=!0,e.saveReport(a.report,function(){setTimeout(function(){c.close(!0)},1e3)})},a.cancel=function(){c.dismiss("cancel")}}]);